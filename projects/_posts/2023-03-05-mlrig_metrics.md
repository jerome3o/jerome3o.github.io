---
layout: post
title: "Machine Learning Rig: Metrics & Montioring"
---

# Adding Monitoring and Metrics to my ML rig with Grafana and Prometheus

Having just finished [building my ML rig](https://www.jeromeswannack.com/projects/2023/02/11/mlrig_build.html) and having a quick play around with it (with a [study plan generated by ChatGPT](https://github.com/jerome3o/pytorch_tut#pytorch-hello-world-projects)) I realised my optics on the functioning of the rig were lacking, I wanted to be able to monitor things like GPU/CPU/RAM usage, and also have a way to monitor the temperature of the GPUs and CPU. Up until this point I just had a SSH+tmux session open running `watch -n 1 rocm-smi` and htop. \

I also have a continually growing number of servers and rpi's that I want to monitor. Finding something that would also work for all of them would be ideal so I set aside a day to look into some monitoring solutions.

## Goals

* Want monitoring/Metrics for the ML rig
  * CPU/GPU/RAM usage
  * Temperature
  * Power usage
* Want to learn reusable skills/tools
* Bonus: Want to be able to monitor other machines (RPi's, other servers, etc)

## Research and Decisions

After a bunch of googling, I had converged on two solutions I was interested in:

### [Weights and Biases](https://wandb.ai/site)

![wandb](/projects/assets/wandb.svg)

  * Is a suite of widely used MLOps monitoring/lifecycle tools
  * Looks like a good out of the box solution for ML monitoring

### [Prometheus](https://prometheus.io/) & [Grafana](https://grafana.com/)

<img src="/projects/assets/prom-icon.svg" width="128" height="128"/>
<img src="/projects/assets/grafana-icon.svg"  width="128" height="128"/>

  * More general purpose monitoring solution
  * A bit more work to set up, but more flexible/General

I decided to go with Prometheus and Grafana for a few reasons:
  * I have several other machines I want to monitor (RPi's, other servers)
  * Eventually want to make a Grafana dashboard for my partner's fish tank (heat/salinity/pH/etc)
  * I love the configurability and general purpose nature of Prometheus and Grafana
  * I have briefly used Prometheus and Grafana before (at work) and wanted to learn more about them
  * I will likely learn about WandB in future projects anyway

## Implementation

* Added [node-exporter](TODO: Link) to all my machines
  * 3 RPis, 2 servers (including the ML rig), 2 PCs, and two laptops
  * Set up [Ansible](TODO: link to ansible) to install node-exporter
    * Ansible was a bit of a learning detour
    * Eventually set up a [repo I was happy with](TODO: Link to ansible-jerome)
      * Inventory with all my devices
      * All sensitive data in a vault
      * Prometheus package installed via ansible-galaxy
      * Playbook setup for node-exporter
* Set up prometheus + grafana on another server with [docker-compose](TODO: link to my compose file somehow?)
* Set up [prometheus.yml](TODO: link to prometheus.yml somehow) and some grafana dashboard
* This was good - had CPU, RAM, Network, storage metrics for all my machines
* Still missing GPU Metrics!
  * Couldn't find any easy out of the box prometheus clients for AMD GPUs (link to random golang one)
  * TODO: google around for pure CUDA prometheus clients! they will probably work
  * Ended up writing a quick n dirty [rocm prom client](TODO: link to rocm-prom-metrics)
    * Had to make a few patches to rocm-smi
    * Deployed on ml rig manually with systemd units so it starts on boot
* All done! had a play around in JupyterLab to see everything was wired up properly 

TODO: Image of dashboard
